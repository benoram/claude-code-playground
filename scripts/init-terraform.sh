#!/usr/bin/env bash
#
# init-terraform.sh - Initialize Terraform with S3 backend configuration
#
# This script reads configuration from SSM Parameter Store and initializes
# Terraform with the S3 backend for state storage.
#
# Prerequisites:
#   - AWS credentials configured (via Roles Anywhere or other method)
#   - Bootstrap stack deployed (./scripts/deploy-bootstrap.sh)
#
# Usage:
#   ./scripts/init-terraform.sh [--region REGION] [--project-name NAME] [--terraform-dir DIR]
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# Default values
REGION="${AWS_REGION:-us-west-2}"
PROJECT_NAME="claude-code-playground"
TERRAFORM_DIR="${REPO_ROOT}/terraform"

# Functions
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

show_help() {
    cat << EOF
Usage: ${0##*/} [OPTIONS]

Initialize Terraform with S3 backend configuration.

Options:
    --region REGION         AWS region (default: ${REGION})
    --project-name NAME     Project name (default: ${PROJECT_NAME})
    --terraform-dir DIR     Terraform directory (default: ${TERRAFORM_DIR})
    --reconfigure           Force reconfiguration of backend
    --help                  Show this help message

Examples:
    # Initialize with defaults
    ${0##*/}

    # Initialize with specific region
    ${0##*/} --region us-west-2

    # Force reconfiguration
    ${0##*/} --reconfigure
EOF
}

check_prerequisites() {
    print_info "Checking prerequisites..."

    # Check AWS CLI
    if ! command -v aws &> /dev/null; then
        print_error "AWS CLI is not installed. Please install it first."
        exit 1
    fi

    # Check Terraform
    if ! command -v terraform &> /dev/null; then
        print_error "Terraform is not installed. Please install it first."
        exit 1
    fi

    # Check AWS credentials
    if ! aws sts get-caller-identity &> /dev/null; then
        print_error "AWS credentials not configured or invalid."
        exit 1
    fi

    print_success "Prerequisites check passed"
}

get_ssm_parameter() {
    local param_name="$1"
    aws ssm get-parameter \
        --name "${param_name}" \
        --region "${REGION}" \
        --query 'Parameter.Value' \
        --output text 2>/dev/null
}

fetch_configuration() {
    print_info "Fetching configuration from SSM Parameter Store..."

    # Get Terraform state configuration
    STATE_BUCKET=$(get_ssm_parameter "/${PROJECT_NAME}/terraform/state-bucket") || {
        print_error "Could not fetch state bucket from SSM. Has the bootstrap stack been deployed?"
        print_error "Run: ./scripts/deploy-bootstrap.sh --first-run"
        exit 1
    }

    STATE_REGION=$(get_ssm_parameter "/${PROJECT_NAME}/terraform/state-region") || STATE_REGION="${REGION}"
    STATE_KMS_KEY=$(get_ssm_parameter "/${PROJECT_NAME}/terraform/state-kms-key-arn") || STATE_KMS_KEY=""

    print_success "Configuration fetched from SSM"
    print_info "  State Bucket: ${STATE_BUCKET}"
    print_info "  State Region: ${STATE_REGION}"
    print_info "  KMS Key ARN:  ${STATE_KMS_KEY}"
}

create_terraform_directory() {
    if [[ ! -d "${TERRAFORM_DIR}" ]]; then
        print_info "Creating Terraform directory: ${TERRAFORM_DIR}"
        mkdir -p "${TERRAFORM_DIR}"
    fi
}

generate_backend_config() {
    print_info "Generating Terraform backend configuration..."

    local backend_file="${TERRAFORM_DIR}/backend.tf"

    cat > "${backend_file}" << EOF
# Terraform S3 Backend Configuration
# Auto-generated by init-terraform.sh
# Do not edit manually - regenerate with ./scripts/init-terraform.sh

terraform {
  backend "s3" {
    bucket       = "${STATE_BUCKET}"
    key          = "terraform.tfstate"
    region       = "${STATE_REGION}"
    encrypt      = true
    kms_key_id   = "${STATE_KMS_KEY}"
    use_lockfile = true
  }
}
EOF

    print_success "Backend configuration written to: ${backend_file}"
}

generate_provider_config() {
    local provider_file="${TERRAFORM_DIR}/provider.tf"

    if [[ -f "${provider_file}" ]]; then
        print_info "Provider configuration already exists, skipping..."
        return
    fi

    print_info "Generating Terraform provider configuration..."

    cat > "${provider_file}" << EOF
# Terraform AWS Provider Configuration
# Auto-generated by init-terraform.sh

terraform {
  required_version = ">= 1.6.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.aws_region

  default_tags {
    tags = {
      Project     = var.project_name
      Environment = var.environment
      ManagedBy   = "Terraform"
    }
  }
}
EOF

    print_success "Provider configuration written to: ${provider_file}"
}

generate_variables_config() {
    local variables_file="${TERRAFORM_DIR}/variables.tf"

    if [[ -f "${variables_file}" ]]; then
        print_info "Variables configuration already exists, skipping..."
        return
    fi

    print_info "Generating Terraform variables configuration..."

    cat > "${variables_file}" << EOF
# Terraform Variables
# Auto-generated by init-terraform.sh

variable "aws_region" {
  description = "AWS region for resources"
  type        = string
  default     = "${STATE_REGION}"
}

variable "project_name" {
  description = "Project name for resource naming and tagging"
  type        = string
  default     = "${PROJECT_NAME}"
}

variable "environment" {
  description = "Environment name (dev/staging/prod)"
  type        = string
  default     = "dev"
}
EOF

    print_success "Variables configuration written to: ${variables_file}"
}

generate_data_sources() {
    local data_file="${TERRAFORM_DIR}/data.tf"

    if [[ -f "${data_file}" ]]; then
        print_info "Data sources configuration already exists, skipping..."
        return
    fi

    print_info "Generating Terraform data sources configuration..."

    cat > "${data_file}" << EOF
# Terraform Data Sources
# Auto-generated by init-terraform.sh
# Fetches configuration from SSM Parameter Store

data "aws_caller_identity" "current" {}
data "aws_region" "current" {}

# SSM Parameters from bootstrap stack
data "aws_ssm_parameter" "terraform_state_bucket" {
  name = "/\${var.project_name}/terraform/state-bucket"
}

data "aws_ssm_parameter" "roles_anywhere_trust_anchor_arn" {
  name = "/\${var.project_name}/roles-anywhere/trust-anchor-arn"
}

data "aws_ssm_parameter" "roles_anywhere_profile_arn" {
  name = "/\${var.project_name}/roles-anywhere/profile-arn"
}

data "aws_ssm_parameter" "roles_anywhere_role_arn" {
  name = "/\${var.project_name}/roles-anywhere/role-arn"
}
EOF

    print_success "Data sources configuration written to: ${data_file}"
}

generate_outputs() {
    local outputs_file="${TERRAFORM_DIR}/outputs.tf"

    if [[ -f "${outputs_file}" ]]; then
        print_info "Outputs configuration already exists, skipping..."
        return
    fi

    print_info "Generating Terraform outputs configuration..."

    cat > "${outputs_file}" << EOF
# Terraform Outputs
# Auto-generated by init-terraform.sh

output "aws_account_id" {
  description = "AWS Account ID"
  value       = data.aws_caller_identity.current.account_id
}

output "aws_region" {
  description = "AWS Region"
  value       = data.aws_region.current.name
}

output "terraform_state_bucket" {
  description = "S3 bucket for Terraform state"
  value       = data.aws_ssm_parameter.terraform_state_bucket.value
}

output "roles_anywhere_trust_anchor_arn" {
  description = "IAM Roles Anywhere Trust Anchor ARN"
  value       = data.aws_ssm_parameter.roles_anywhere_trust_anchor_arn.value
}

output "roles_anywhere_profile_arn" {
  description = "IAM Roles Anywhere Profile ARN"
  value       = data.aws_ssm_parameter.roles_anywhere_profile_arn.value
}

output "roles_anywhere_role_arn" {
  description = "IAM Roles Anywhere Role ARN"
  value       = data.aws_ssm_parameter.roles_anywhere_role_arn.value
}
EOF

    print_success "Outputs configuration written to: ${outputs_file}"
}

initialize_terraform() {
    print_info "Initializing Terraform..."

    cd "${TERRAFORM_DIR}"

    local init_args=("-input=false")
    if [[ "${RECONFIGURE:-false}" == "true" ]]; then
        init_args+=("-reconfigure")
    fi

    if terraform init "${init_args[@]}"; then
        print_success "Terraform initialized successfully"
    else
        print_error "Terraform initialization failed"
        exit 1
    fi

    cd "${REPO_ROOT}"
}

validate_terraform() {
    print_info "Validating Terraform configuration..."

    cd "${TERRAFORM_DIR}"

    if terraform validate; then
        print_success "Terraform configuration is valid"
    else
        print_warning "Terraform validation encountered issues"
    fi

    cd "${REPO_ROOT}"
}

show_next_steps() {
    echo ""
    print_info "Terraform is ready to use!"
    echo ""
    echo "Next steps:"
    echo "  cd ${TERRAFORM_DIR}"
    echo "  terraform plan"
    echo "  terraform apply"
    echo ""
    echo "Useful commands:"
    echo "  terraform fmt      - Format configuration files"
    echo "  terraform validate - Validate configuration"
    echo "  terraform plan     - Show execution plan"
    echo "  terraform apply    - Apply changes"
    echo "  terraform state    - Manage state"
    echo ""
}

# Parse arguments
RECONFIGURE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --region)
            REGION="$2"
            shift 2
            ;;
        --project-name)
            PROJECT_NAME="$2"
            shift 2
            ;;
        --terraform-dir)
            TERRAFORM_DIR="$2"
            shift 2
            ;;
        --reconfigure)
            RECONFIGURE=true
            shift
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

# Main execution
main() {
    echo ""
    echo "=============================================="
    echo "  Terraform Initialization"
    echo "=============================================="
    echo ""
    print_info "Region:         ${REGION}"
    print_info "Project:        ${PROJECT_NAME}"
    print_info "Terraform Dir:  ${TERRAFORM_DIR}"
    print_info "Reconfigure:    ${RECONFIGURE}"
    echo ""

    check_prerequisites
    fetch_configuration
    create_terraform_directory
    generate_backend_config
    generate_provider_config
    generate_variables_config
    generate_data_sources
    generate_outputs
    initialize_terraform
    validate_terraform
    show_next_steps
}

main "$@"
